#!/bin/bash
# ~/.git-global-hooks/post-commit


MAX_TOTAL_SIZE=50000        # Taille max totale du diff (caractÃ¨res)
MAX_FILE_SIZE=10000         # Taille max par fichier (caractÃ¨res)
CLAUDE_TIMEOUT=30           # Timeout pour Claude en secondes

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

run_with_timeout() {
    local timeout=$1
    shift

    ( "$@" ) & pid=$!
    ( sleep "$timeout" && kill -TERM $pid 2>/dev/null ) & watcher=$!

    if wait $pid 2>/dev/null; then
        kill -TERM $watcher 2>/dev/null
        return 0
    else
        local exit_code=$?
        kill -TERM $watcher 2>/dev/null
        if [ $exit_code -eq 143 ] || [ $exit_code -eq 124 ]; then
            return 124
        fi
        return $exit_code
    fi
}

is_binary_file() {
    local file="$1"
    git show "HEAD:$file" 2>/dev/null | grep -qI . || return 0
    return 1
}

get_file_diff_size() {
    local file="$1"
    git show HEAD -- "$file" 2>/dev/null | wc -c
}

echo -e "${BLUE}ğŸ¤– Claude Code analyse votre dernier commit...${NC}"

changed_files=$(git diff-tree --no-commit-id --name-only --diff-filter=ACMRTUXB -r HEAD)

if [ -z "$changed_files" ]; then
    echo -e "${YELLOW}âš ï¸  Aucun fichier modifiÃ© dÃ©tectÃ©${NC}"
    exit 0
fi

filtered_files=""
excluded_count=0
excluded_reasons=""

while IFS= read -r file; do
    [ -z "$file" ] && continue

    if ! git cat-file -e "HEAD:$file" 2>/dev/null; then
        continue
    fi
    if is_binary_file "$file"; then
        ((excluded_count++))
        excluded_reasons="${excluded_reasons}  - $file (binaire)\n"
        continue
    fi

    case "$file" in
        *package-lock.json|*yarn.lock|*pnpm-lock.yaml|*composer.lock|*Cargo.lock|*Gemfile.lock)
            ((excluded_count++))
            excluded_reasons="${excluded_reasons}  - $file (lock file)\n"
            continue
            ;;
    esac

    file_size=$(get_file_diff_size "$file")
    if [ "$file_size" -gt "$MAX_FILE_SIZE" ]; then
        ((excluded_count++))
        excluded_reasons="${excluded_reasons}  - $file (trop volumineux: $file_size caractÃ¨res)\n"
        continue
    fi

    filtered_files="${filtered_files}${file}"$'\n'
done <<< "$changed_files"

if [ "$excluded_count" -gt 0 ]; then
    echo -e "${YELLOW}âš ï¸  $excluded_count fichier(s) exclu(s) de la review:${NC}"
    echo -e "${excluded_reasons}"
fi
if [ -z "$filtered_files" ]; then
    echo -e "${YELLOW}âš ï¸  Aucun fichier valide Ã  analyser${NC}"
    exit 0
fi

diff_content=$(git show HEAD --ignore-all-space -- $filtered_files 2>/dev/null)
total_size=$(echo "$diff_content" | wc -c)

if [ "$total_size" -gt "$MAX_TOTAL_SIZE" ]; then
    echo -e "${YELLOW}âš ï¸  Diff trop volumineux (${total_size} caractÃ¨res, max: ${MAX_TOTAL_SIZE})${NC}"
    echo -e "${YELLOW}   Review Claude ignorÃ©e pour Ã©conomiser les tokens${NC}"
    exit 0
fi

if [ -z "$diff_content" ]; then
    echo -e "${YELLOW}âš ï¸  Diff vide aprÃ¨s filtrage${NC}"
    exit 0
fi

echo -e "${GREEN}âœ“${NC} Analyse de $(echo "$filtered_files" | grep -c '^') fichier(s) (${total_size} caractÃ¨res)..."

PROMPT="Tu es un Code Reviewer expert. Analyse ce commit git et identifie UNIQUEMENT les problÃ¨mes critiques:

ğŸ› Bugs potentiels
ğŸ”’ Failles de sÃ©curitÃ©
âš¡ ProblÃ¨mes de performance graves
âŒ Erreurs logiques

Si tout est propre, rÃ©ponds simplement 'LGTM âœ…'.
Sois trÃ¨s concis (max 4 lignes) et factuel."

REVIEW=$(run_with_timeout "$CLAUDE_TIMEOUT" claude -p "$PROMPT" <<< "$diff_content" 2>&1)
review_exit_code=$?
echo ""
echo -e "${BLUE}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
echo -e "${BLUE}â”‚${NC}                  ${GREEN}ğŸ§  CLAUDE REVIEW${NC}                       ${BLUE}â”‚${NC}"
echo -e "${BLUE}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
echo ""

if [ $review_exit_code -eq 124 ]; then
    echo -e "${RED}â±ï¸  Timeout: Claude n'a pas rÃ©pondu dans les ${CLAUDE_TIMEOUT}s${NC}"
elif [ $review_exit_code -ne 0 ]; then
    echo -e "${RED}âŒ Erreur lors de l'appel Ã  Claude (code: $review_exit_code)${NC}"
    echo -e "${YELLOW}$REVIEW${NC}"
elif [ -z "$REVIEW" ]; then
    echo -e "${YELLOW}âš ï¸  Pas de rÃ©ponse de Claude${NC}"
else
    if echo "$REVIEW" | grep -qi "LGTM"; then
        echo -e "${GREEN}$REVIEW${NC}"
    else
        echo "$REVIEW"
    fi
fi

echo ""
echo -e "${BLUE}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""
